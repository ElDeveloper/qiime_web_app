.. _tutorial:

======================================
QIIME Web-Interface Overview Tutorial
======================================

Introduction
-------------
This tutorial explains how to use the **QIIME** (Quantitative Insights Into Microbial Ecology) Web-Interface to process data from high-throughput 16S rRNA sequencing studies. The purpose of this tutorial is to provide a start-to-finish workflow, beginning with the creation of a study, uploading the corresponding SFF and MIENS-compliant metadata through generating a composite list of sequences, OTU table, and QIIME-formatted mapping file. With this information in hand, it is possible to determine biological and environmental factors that alter microbial community ecology in your experiment in comparison to other experiments.

As an example, we will not use data from a study of the response of mouse gut microbial communities to fasting (Crawford et al., 2009). At the end of our tutorial, we will be able to compare the community structure of control vs. fasted animals. In particular, we will be able to compare taxonomic profiles for each sample type, differences in diversity metrics within the samples and between the groups, and perform comparative clustering analysis to look for overall differences in the samples.

To load and process our data, we will perform the following steps:

* Create a unique study for our dataset
* Generate MIENS-compliant metadata templates
* Use the Ontology Lookup and GeoReferencing Tool for filling in Ontology specific metadata fields
* Upload MIENS-compliant metadata and corresponding SFF files
* Create a meta-analysis
* Select and generate Sequences file, OTU table and QIIME-formatted metadata file.



Essential Files
-----------------

MIENS-Compliant Metadata Files (.xls or .txt)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
These are the tab-delimited templates generated using the QIIME Web-Interface, once you have created a unique study for your experiment and identified the type of study (i.e., host-associated, human-gut, human-oral, etc.).

Flowgram File (.sff)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
This is the 454-machine generated file which stores the sequencing trace data. This is the largest file returned from a 454 run.

Create a Study
---------------
Once the user has logged in, we can create a study, by clicking on the link "Create a New Study".  For the QIIME Web-Interface, a study is classified as one or more sequencing runs that are part of the same study, which means there will be one set of MIENS-compliant templates for one or more Sequencing Runs (SFFs).

.. image:: ../images/QWA_New_Study_1.png
    :align: center
    :width: 600 px
    
Once redirected to the new study page, the user must create a unique Study Name.  The Study Name is unique to the database, not just to an individual's account, which means that if you type "mice" it is most likely someone else has used that study name. Therefore you will want to create a unique study name, such as the combination of the first author's last name and the type of study (e.g. Turnbaugh_Obese_and_Lean_Twins).

.. image:: ../images/QWA_New_Study_2.png
    :align: center
    :width: 600 px
    
Once a Study Name has been defined, the user must select the Investigation Type for their study (i.e. MIENS-survey, metagenome, virus, etc.), however; most commonly users will be submitting a 16S rRNA MIENS-survey.

.. image:: ../images/QWA_New_Study_3.png
    :align: center
    :width: 600 px

Along with the Investigation Type, the user must select one or multiple environmental packages that their study comprises. These fields determine which MIENS fields are required for submission of the study.

.. image:: ../images/QWA_New_Study_4.png
    :align: center
    :width: 600 px

Finally, the user must select whether this study has or will be submitted to The International Nucleotide Sequence Database Collaboration (INSDC).

.. image:: ../images/QWA_New_Study_5.png
    :align: center
    :width: 600 px
    
Once all the fields have been filled out, the user must click the "Next" button.

.. image:: ../images/QWA_New_Study_6.png
    :align: center
    :width: 600 px

Generate MIENS-Compliant Templates
----------------------------------
To create the MIENS-compliant templates the user should select the link "Generate a MIENS-compliant metadata template".

.. image:: ../images/QWA_Generate_MIENs_1.png
    :align: center
    :width: 600 px

On the next page, the user will be presented with a large HTML table, which lists all the appropriate MIENS-compliant fields.  Rows with the Pink background denote fields that are required (either by MIENS or depending on the package(s) corresponding to this study).  If the user has other information pertaining to their study and the field is not required, the user can select specific columns, to add to their templates, by clicking on the checkbox next to the left of each field.  We recommend that you select all fields that apply, since the more information you put into these templates, the more useful the data becomes, when inserted into the database.

.. image:: ../images/QWA_Generate_MIENs_2.png
    :align: center
    :width: 700 px

If there is a field that the user thinks may be in the database, but they do not see it in the table, they can start typing the word(s) in the input box at the bottom of the page.  This will search the database and show other fields that are present, using auto-complete functionality.  If you cannot find a field, then we recommend you add the column to your sample template and it will be parsed and added to the database.

.. image:: ../images/QWA_Generate_MIENs_3.png
    :align: center
    :width: 700 px

Once you have checked all the fields that apply, you can click the "Generate Templates" button.

.. image:: ../images/QWA_Generate_MIENs_4.png
    :align: center
    :width: 700 px

Once you have clicked "Generate Templates", you will be redirected to another page, where you can download the templates by clicking "Download zip archives of all files".

.. image:: ../images/QWA_Generate_MIENs_5.png
    :align: center
    :width: 600 px
    
Ontology Lookup and Georeferencing Tool
---------------------------------------

When filling out the MIENS-compliant metadata templates, some fields require ontological terminology.  To learn about which fields require ontological terminology, the user should refer to the field_reference template file. To aid in filling out these columns, we have developed an Ontology Lookup and GeoReferencing Tool. Initially, the user should fill in these fields with the terms they would associate to this field. To access this tool, the user should click on the Ontology Lookup and Georeferencing Utility link. 

.. image:: ../images/QWA_Ontology_Geo_1.png
    :align: center
    :width: 600 px
    
The user will be redirected to the Ontology Lookup Tool.

.. image:: ../images/QWA_Ontology_Geo_2.png
    :align: center
    :width: 600 px

The first step for using the Ontology Lookup Tool is to select and copy the column from there template (" |apple| +C" key on Mac or "CTRL+C" on PC). 

    
.. image:: ../images/QWA_Ontology_Geo_3.png
    :align: center
    :width: 600 px

Then the user should click on the Input Data select-box and paste the column (" |apple| +V" key on Mac or "CTRL+V" on PC).

.. |apple| unicode:: U+02318 .. apple command
    :trim:

.. image:: ../images/QWA_Ontology_Geo_4.png
    :align: center
    :width: 600 px

Once the users column has been pasted, the user should select which Ontology they want to search for their terms (i.e. FMA, ENVO, GAZ, etc.).

.. image:: ../images/QWA_Ontology_Geo_5.png
    :align: center
    :width: 600 px

Once the ontology(s) have been selected the user should click on the button "Input Data".

.. image:: ../images/QWA_Ontology_Geo_6.png
    :align: center
    :width: 600 px

The user should notice that there are a new input boxes created below, where their list of terms should have been dereplicated.

.. image:: ../images/QWA_Ontology_Geo_7.png
    :align: center
    :width: 600 px

Now that the terms have been dereplicated, the user should click on each input box, which will produce a list (up to 20 terms) below the input box where the user must should select the term that best describes their initial term.  If you get no results, then you may want to try another term, by typing in the input box, until you find the term that best relates to your sample.  Note: some ontology terms can only be defined at the resolution allowed by the ontology (e.g. Rat feces can only be defined as feces).

.. image:: ../images/QWA_Ontology_Geo_8.png
    :align: center
    :width: 600 px
    
Once all the terms have been updated, you should see checks next to each term, if so, then click "Output Data", where a new a window will pop-up and the user can select/copy and paste that list back into their template.  If there are no checkmarks, then the user will need to modify the term in the input boxes, until they get checkmarks.

.. image:: ../images/QWA_Ontology_Geo_9.png
    :align: center
    :width: 600 px
    
A new pop-up window will be produced where the use can select and copy the list (" |apple| +C" key on Mac or "CTRL+C" on PC).

.. image:: ../images/QWA_Ontology_Geo_10.png
    :align: center
    :width: 300 px

Once the list has been copied the user can paste it back into their template, using " |apple| +V" key on Mac or "CTRL+V" on PC. 

.. image:: ../images/QWA_Ontology_Geo_11.png
    :align: center
    :width: 600 px

    
To use the Georeferencing tool, the user should select the "Latitude/Longitude/Elevation" link.

.. image:: ../images/QWA_Ontology_Geo_12.png
    :align: center
    :width: 600 px

In the Georeferencing tool, the user can create a list of Latitudes, Longitudes, and Elevations.  First the user should type in a location in the "Enter Location" box.

.. image:: ../images/QWA_Ontology_Geo_13.png
    :align: center
    :width: 600 px

Next the user should click on the "Verify Location" button, which will create a tooltip on the map below of the location.  The user should verify that the location is correct, since locations like "Columbus" can mean "Columbus, OH" or "Columbus, GA", for which you will need to be more specific.  Note: If you can only describe your samples at the location of a country, you can specify only a country.

.. image:: ../images/QWA_Ontology_Geo_14.png
    :align: center
    :width: 600 px

Once you location is correct, the user needs input the the number of rows in their template. 

.. image:: ../images/QWA_Ontology_Geo_15.png
    :align: center
    :width: 600 px

Next the user should select which field they would like to output (Lat/Long/Elev).

.. image:: ../images/QWA_Ontology_Geo_16.png
    :align: center
    :width: 600 px

To create the list of Lat/Long/Elev the user needs to click on the "Output Data" button", which will produce a pop-up containing the appropriate data, which can be selected and copied (" |apple| +C" key on Mac or "CTRL+C" on PC).

.. image:: ../images/QWA_Ontology_Geo_17.png
    :align: center
    :width: 300 px

Then, the user can paste the list into their template (" |apple| +V" key on Mac or "CTRL+V" on PC).

.. image:: ../images/QWA_Ontology_Geo_18.png
    :align: center
    :width: 600 px
    
    
Upload MIENS-Compliant Templates 
-----------------------------------------

To upload your MIENS-compliant metadata files, you must first zip the templates into a single archive. Then you must select the link Upload metadata to this study.  Note: once you successfully upload the SFF files, the "(not complete)" message and X will change to "(complete)" and a checkmark will appear next to this link.

.. image:: ../images/QWA_Upload_Meta_1.png
    :align: center
    :width: 600 px

Once redirected, you may see an applet permission pop-up, where the user should click on the "Allow" button.  The reason for this message is that the browser is trying to verify the use of the java applet.  Once the applet has loaded, the user can drag-n-drop their MIENS-compliant template archive onto the applet, or click on the "Add..." button.

.. image:: ../images/QWA_Upload_Meta_2.png
    :align: center
    :width: 600 px

If the user selects "Add..." a window should pop-up.  In this window the user should locate their zipped file and select it.

.. image:: ../images/QWA_Upload_Meta_3.png
    :align: center
    :width: 400 px

Once the zipped file is selected the user should click "Open".

.. image:: ../images/QWA_Upload_Meta_4.png
    :align: center
    :width: 400 px

Once the file shows up in the applet window, the user should click on "Start Upload" button on the bottom left corner of the applet.

.. image:: ../images/QWA_Upload_Meta_5.png
    :align: center
    :width: 600 px

If there are columns in the metadata templates that are user specific, then a page will ask the user to describe these new columns.

.. image:: ../images/QWA_Upload_Meta_6.png
    :align: center
    :width: 600 px

After describing the column, the user should select the type of data in that will be found in that column.

.. image:: ../images/QWA_Upload_Meta_7.png
    :align: center
    :width: 600 px

Once the user has filled in the description and selected the data-type for each user-specified column, you should click on the "Continue" button.

.. image:: ../images/QWA_Upload_Meta_8.png
    :align: center
    :width: 600 px
    
The user will now be redirected to another page where each template is loaded into an HTML table.  If there are errors, the user will observe an input box in the column denoting the user needs to update and correct the specified fields.  The user should click on the input box and update the field.

.. image:: ../images/QWA_Upload_Meta_9.png
    :align: center
    :width: 600 px

Once corrected, the user should not that the background of the input box will turn green.

.. image:: ../images/QWA_Upload_Meta_10.png
    :align: center
    :width: 600 px

After making all the corrections, the user should scroll to the bottom of the page and click on the "Submit Metadata" button.

.. image:: ../images/QWA_Upload_Meta_11.png
    :align: center
    :width: 600 px

This will redirect the user to another page, where they can observe the loading progress and if successful, they we see a fun fireworks animation.

.. image:: ../images/QWA_Upload_Meta_12.png
    :align: center
    :width: 600 px

Upload SFFs
------------

To upload your SFF files, you must first zip one or more SFFs into a single archive, depending on the SFFs listed in the RUN_PREFIX of your MIENS-compliant metadata templates.  First you must select the link Upload SFF files to this study.  Note: once you successfully upload the SFF files, the "(not complete)" message and X will change to "(complete)" and a checkmark will appear next to this link.

.. image:: ../images/QWA_Upload_SFF_1.png
    :align: center
    :width: 600 px

Once redirected, you may see an applet permission pop-up, where the user should click on the "Allow" button.  The reason for this message is that the browser is trying to verify the use of the java applet.  Once the applet has loaded, the user can drag-n-drop their SFF archive onto the applet, or click on the "Add..." button.

.. image:: ../images/QWA_Upload_SFF_2.png
    :align: center
    :width: 600 px

Once the file shows up in the applet window, the user should click on "Start Upload" button on the bottom left corner of the applet.

.. image:: ../images/QWA_Upload_SFF_3.png
    :align: center
    :width: 600 px

If there are no errors and the files upload correctly, the user will be redirected to the "Select Task" page.  If the job fails, there could be several reasons, such as the SFF files in the zip archive are corrupt or missing from the archive.


Create Meta-Analysis
--------------------

Now that a user would like to compare their samples with other samples in the database or if the user would just like to compare public samples in the datbase, they must first create a Meta-Analysis. The user should click on the "Create a New Meta-Analysis" link, which will redirect the user to a page containing a single input box.

.. image:: ../images/QWA_Create_MetaAnalysis_1.png
    :align: center
    :width: 600 px

First, you should type in a Meta-Analysis Name. Note: this name is a unique identifier for the user.

.. image:: ../images/QWA_Create_MetaAnalysis_2.png
    :align: center
    :width: 600 px

Then, the user should click the "Next" button, which will redirect the user to the Meta-Analysis frontpage.

.. image:: ../images/QWA_Create_MetaAnalysis_3.png
    :align: center
    :width: 600 px

Generate Sequences File, OTU Table and QIIME-Formatted Metadata File
---------------------------------------------------------------------

If the user was redirected to the main Meta-Analysis frontpage, then they can skip the next step.  If the user has already created their Meta-Analysis, they can generate a sequences file (FASTA), OTU table, and QIIME-Formatted mapping file by selecting a Meta-Analysis from the select box for "Select Previous Meta-Analysis" on the "Select Task" home page, which will redirect the user to the Meta-Analysis frontpage.

.. image:: ../images/QWA_Generate_OTU_1.png
    :align: center
    :width: 600 px

Next, the user should click on the link "Generate OTU table and metadata file"????, which will redirect the user to the sample selection page.

.. image:: ../images/QWA_Generate_OTU_2.png
    :align: center
    :width: 600 px

On the sample selection page, the user should first give a filename prefix to the files they will produce.  You should also, specify the taxonomic assignment that you would like to be represented in the OTU table. 

.. image:: ../images/QWA_Generate_OTU_3.png
    :align: center
    :width: 600 px

You can select the fields you would like outputted by selecting a field in the left select-box and either double-clicking that field or clicking on the ">" button to move it to the right select-box.

.. image:: ../images/QWA_Generate_OTU_4.png
    :align: center
    :width: 600 px

When the user selects a field in the left select-box they should notice a gray table appear below which gives information about that particular field, however; when they select a field in the right select-box, they will see an additional column containing values found for that particular field.  From the Values box, the user should select values that correspond to the types of samples they would like to compare.  If no values are selected, then all samples will be taken.

.. image:: ../images/QWA_Generate_OTU_5.png
    :align: center
    :width: 600 px

If the user would like to reduce the number of fields and select samples based on specific fields, they can select one of the categories for the fields (e.g. Study, package-specific, etc.).




References
------------
Crawford, P. A., Crowley, J. R., Sambandam, N., Muegge, B. D., Costello, E. K., Hamady, M., et al. (2009). Regulation of myocardial ketone body metabolism by the gut microbiota during nutrient deprivation. Proc Natl Acad Sci U S A, 106(27), 11276-11281.

.. _Cytoscape: http://www.cytoscape.org/
.. _PyNAST: http://pynast.sourceforge.net/
.. _Unifrac: http://bmf2.colorado.edu/unifrac/index.psp
