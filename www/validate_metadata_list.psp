<%
__author__ = "Doug Wendel"
__copyright__ = "Copyright 2009-2010, Qiime Web Analysis"
__credits__ = ["Doug Wendel"]
__license__ = "GPL"
__version__ = "1.0.0.dev"
__maintainer__ = ["Doug Wendel", "Jesse Stombaugh"]
__email__ = "wendel@colorado.edu"
__status__ = "Development"
%>

<%@ include file="header.psp" %>

<script type="text/javascript" src="js/template.js"></script>

<h2>Metadata Validation</h2>

<form target="_top" name="metadata_form" id="metadata_form" method="post" action="fusebox.psp" onsubmit="return validateCorrectedMetadata();">
<input type="hidden" id="page" name="page" value="submit_corrected_metadata.psp"/>

<%
from metadata_table import *

templates = sess["templates"]
forward = True

if templates != None:
    draw_submit = True
    
    for template in templates:
        req.write('<h3> Results for file: ' + os.path.basename(template) + '</h3>')
        log = []
        try:
            log.append('Creating metadata table for file "%s"' % template)
            table = MetadataTable(template, sess['study_id'])
            log.append('Reading metadata file...')
            table.processMetadataFile()
            log.append('Printing HTML table...')
            html_table, error_log, visible_elements = table.printHTMLTable()
            req.write(str(html_table))

            if not visible_elements:
                req.write('No corrections necessary.')
            else:
                forward = False
            
            if error_log:
                draw_submit = False
                for line in error_log:
                    req.write(line + '<br/>\n')

            req.write('<p/>')
        
        except Exception, e:
            req.write('An error has occurred:<br/>')
            for entry in log:
                req.write(entry + '<br/>')
            
            req.write('<br/>The Exception was:')
            req.write(str(e) + '<p/>')
            req.write('<p/>Please email your metadata archive and a copy of this error page to: <a href="mailto:wendel@colorado.edu">wendel@colorado.edu</a>.')
            draw_submit = False
            break
    
    if forward:
        req.write('<script type="text/javascript">document.forms["metadata_form"].submit();</script>')
    elif draw_submit and not forward:
        req.write('<p/>')
        req.write('<input type="submit" id="metadata_submit" value="Submit Metadata"><br/>')
        req.write('<p/>')
        
    # End if

# End if
%>

</form>

<%@ include file="footer.psp" %>
